---
import { commentConfig } from "@/config";
import "@waline/client/style";

interface Props {
	path: string;
}

const config = {
	...commentConfig.waline,
	path: Astro.props.path,
	dark: "html.dark",
};
---

<div class="waline-wrapper">
    <div id="waline" data-config={JSON.stringify(config)}></div>
</div>

<script>
    import { init } from '@waline/client';
    import '@waline/client/meta';

    function loadWaline() {
        const walineEl = document.getElementById('waline');
        if (walineEl && walineEl.dataset.config) {
            try {
                const config = JSON.parse(walineEl.dataset.config);
                init({
                    el: walineEl,
                    ...config
                });
            } catch (e) {
                console.error('Failed to parse waline config', e);
            }
        }
    }

    const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
            if (entry.isIntersecting) {
                loadWaline();
                observer.disconnect();
            }
        });
    });

    const wrapper = document.querySelector('.waline-wrapper');
    if (wrapper) {
        observer.observe(wrapper);
    }
</script>

<style is:global>
    /* --- Waline 美化样式 --- */
    :root {
        /* 1. 颜色适配：让按钮和高亮色跟随主题 */
        --waline-theme-color: var(--primary);
        --waline-active-color: var(--primary);
        
        /* 2. 字体与背景适配 */
        --waline-font-size: 1rem;
        --waline-bg-color-light: var(--card-bg);
        
        /* 3. 边框与圆角：跟随 Fuwari 的圆润风格 */
        --waline-border-color: var(--line-divider);
        --waline-avatar-radius: 50%;
        --waline-box-shadow: none; /* 去掉默认阴影，以免双重阴影 */
    }
    /* 暗黑模式适配微调 */
    html.dark {
        --waline-border-color: rgba(255, 255, 255, 0.1);
        --waline-bgcolor: #1e1e1e;
        --waline-bgcolor-light: #2a2a2a;

        /* 修复暗色模式下 Reaction 组件文字颜色不可见的问题 */
        --waline-color: rgba(255, 255, 255, 0.9);
    }

    /* 针对 Reaction 组件及评论计数的强制覆盖 */
    html.dark .wl-reaction-title,
    html.dark .wl-reaction-text,
    html.dark .wl-count {
        color: rgba(255, 255, 255, 0.9);
    }
    /* --- 细节修饰 --- */
    
    /* 输入框美化 */
    .wl-editor {
    transition: all 0.3s ease;
    border-radius: 1rem !important; /* 更大的圆角 */
    padding: 1rem !important;
    }
    /* 按钮美化 */
    .wl-btn.primary {
        border-radius: 0.75rem !important;
        border: none !important;
        background: var(--primary) !important;
        color: white !important;
        box-shadow: 0 4px 10px -2px var(--primary-20) !important;
    }
    /* 去掉多余的版权信息边距 */
    .wl-power {
        margin-top: 0.5rem !important;
        font-size: 0.75rem !important;
    }
    /* 调整卡片内部间距 */
    .waline-wrapper {
        margin-top: 0.5rem;
    }
</style>
