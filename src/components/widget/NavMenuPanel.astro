---
import { Icon } from "astro-icon/components";
import { LinkPresets } from "../../constants/link-presets";
import { type NavBarLink } from "../../types/config";
import { url } from "../../utils/url-utils";

interface Props {
	links: NavBarLink[];
}

const links = Astro.props.links;

function resolveChildren(link: NavBarLink): NavBarLink[] {
	return (
		link.children?.map((child) =>
			typeof child === "number" ? LinkPresets[child] : child,
		) ?? []
	);
}

const maxLabelLength = Math.max(
	...links.flatMap((link) => [
		link.name.length,
		...resolveChildren(link).map((child) => child.name.length),
	]),
);
---
<div
    id="nav-menu-panel"
    style={`--nav-menu-max-label-length: ${Math.max(6, maxLabelLength)}`}
    class:list={["float-panel float-panel-closed absolute transition-all fixed right-4 px-2 py-2 overflow-hidden"]}
>
    {links.map((link) => {
        const children = resolveChildren(link);
        const hasChildren = children.length > 0;

        if (!hasChildren) {
            if (!link.url) return null;
            return (
                <a href={link.external ? link.url : url(link.url)} class="group flex justify-between items-center py-2 pl-3 pr-1 rounded-lg gap-3 min-w-0
                    hover:bg-[var(--btn-plain-bg-hover)] active:bg-[var(--btn-plain-bg-active)] transition
                "
                    target={link.external ? "_blank" : null}
                >
                    <div class="transition text-black/75 dark:text-white/75 font-bold group-hover:text-[var(--primary)] group-active:text-[var(--primary)] truncate">
                        {link.name}
                    </div>
                    {!link.external && <Icon name="material-symbols:chevron-right-rounded"
                        class="transition text-[1.25rem] text-[var(--primary)]"
                    >
                    </Icon>}
                    {link.external && <Icon name="fa6-solid:arrow-up-right-from-square"
                        class="transition text-[0.75rem] text-black/25 dark:text-white/25 -translate-x-1"
                    >
                    </Icon>}
                </a>
            );
        }

        return (
            <div class="flex flex-col">
                <button
                    type="button"
                    class="group flex w-full justify-between items-center py-2 pl-3 pr-1 rounded-lg gap-3 min-w-0
                        hover:bg-[var(--btn-plain-bg-hover)] active:bg-[var(--btn-plain-bg-active)] transition"
                    data-nav-parent
                    aria-expanded="false"
                >
                    <div class="transition text-black/75 dark:text-white/75 font-bold group-hover:text-[var(--primary)] group-active:text-[var(--primary)] truncate">
                        {link.name}
                    </div>
                    <Icon
                        name="material-symbols:keyboard-arrow-down-rounded"
                        class="transition text-[1.25rem] text-[var(--primary)] -translate-x-0.5"
                        data-nav-arrow
                    />
                </button>
                <div class="hidden pl-3" data-nav-submenu>
                    {children.map((child) => (
                        <a
                            href={child.external ? child.url : url(child.url)}
                            target={child.external ? "_blank" : null}
                            rel={child.external ? "noopener noreferrer" : null}
                            class="group flex justify-between items-center py-2 pl-3 pr-1 rounded-lg gap-3 min-w-0
                                hover:bg-[var(--btn-plain-bg-hover)] active:bg-[var(--btn-plain-bg-active)] transition"
                        >
                            <div class="transition text-black/75 dark:text-white/75 font-medium group-hover:text-[var(--primary)] group-active:text-[var(--primary)] truncate">
                                {child.name}
                            </div>
                            {!child.external && (
                                <Icon
                                    name="material-symbols:chevron-right-rounded"
                                    class="transition text-[1.25rem] text-[var(--primary)]"
                                />
                            )}
                            {child.external && (
                                <Icon
                                    name="fa6-solid:arrow-up-right-from-square"
                                    class="transition text-[0.75rem] text-black/25 dark:text-white/25 -translate-x-1"
                                />
                            )}
                        </a>
                    ))}
                </div>
            </div>
        );
    })}
</div>

<script>
function initNavMenuPanel() {
	const panel = document.getElementById("nav-menu-panel");
	if (!panel) return;

	const parents = panel.querySelectorAll("[data-nav-parent]");
	parents.forEach((btn) => {
		if (!(btn instanceof HTMLButtonElement)) return;
		if (btn.dataset.bound === "1") return;
		btn.dataset.bound = "1";

		btn.addEventListener("click", (e) => {
			e.preventDefault();
			const container = btn.parentElement;
			const submenu = container?.querySelector("[data-nav-submenu]");
			if (!(submenu instanceof HTMLElement)) return;

			const expanded = btn.getAttribute("aria-expanded") === "true";
			btn.setAttribute("aria-expanded", String(!expanded));
			submenu.classList.toggle("hidden", expanded);

			const arrow = btn.querySelector("[data-nav-arrow]");
			if (arrow instanceof HTMLElement) {
				arrow.classList.toggle("rotate-180", !expanded);
			}
		});
	});
}

initNavMenuPanel();
document.addEventListener("content:replace", initNavMenuPanel);
document.addEventListener("astro:after-swap", initNavMenuPanel);
</script>

<style>
#nav-menu-panel {
	width: clamp(
		10rem,
		calc(var(--nav-menu-max-label-length) * 1.1ch + 4.75rem),
		calc(100vw - 2rem)
	);
}
</style>
