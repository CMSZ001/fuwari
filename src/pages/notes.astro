---
import MarkdownIt from "markdown-it";
import sanitizeHtml from "sanitize-html";
import ImageWrapper from "../components/misc/ImageWrapper.astro";
import rawData from "../data/notes.yml";
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import MainGridLayout from "../layouts/MainGridLayout.astro";

// 获取随笔数据
type Note = {
	content: string;
	date: string;
	images?: string[];
	location?: string;
	mood?: string;
};
const rawList = (rawData as Note[]) ?? [];
const notes = rawList
	.slice()
	.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

const chunkSize = 5;
const groups: Note[][] = [];
for (let i = 0; i < notes.length; i += chunkSize) {
	groups.push(notes.slice(i, i + chunkSize));
}

const notesStats = {
	total: notes.length,
	hasImages: notes.filter((i) => i.images && i.images.length > 0).length,
	hasLocation: notes.filter((i) => i.location).length,
	hasMood: notes.filter((i) => i.mood).length,
	imagePercentage: notes.length
		? Math.round(
				(notes.filter((i) => i.images && i.images.length > 0).length /
					notes.length) *
					100,
			)
		: 0,
	locationPercentage: notes.length
		? Math.round((notes.filter((i) => i.location).length / notes.length) * 100)
		: 0,
	moodPercentage: notes.length
		? Math.round((notes.filter((i) => i.mood).length / notes.length) * 100)
		: 0,
};

const markdownParser = new MarkdownIt({ html: true });
function renderMarkdown(md: string) {
	const html = markdownParser.render(String(md ?? ""));
	return sanitizeHtml(html, {
		allowedTags: sanitizeHtml.defaults.allowedTags.concat([
			"img",
			"span",
			"br",
			"sup",
			"sub",
		]),
		allowedAttributes: {
			...sanitizeHtml.defaults.allowedAttributes,
			img: ["src", "alt"],
			a: ["href", "name", "target"],
			span: ["class"],
		},
		allowedClasses: {
			span: ["blink"],
		},
	});
}

// 时间格式化函数
function formatTime(dateString: string): string {
	var TG = 8;
	const timeGap = TG;

	// const lang = siteConfig.lang;
	const now = new Date();
	const date = new Date(dateString);
	const diffInMinutes = Math.floor(
		(now.getTime() + timeGap * 60 * 60 * 1000 - date.getTime()) / (1000 * 60),
	);

	if (diffInMinutes < 60) {
		return `${diffInMinutes}${i18n(I18nKey.notesMinutesAgo)}`;
	}
	if (diffInMinutes < 1440) {
		// 24小时
		const hours = Math.floor(diffInMinutes / 60);
		return `${hours}${i18n(I18nKey.notesHoursAgo)}`;
	}
	const days = Math.floor(diffInMinutes / 1440);
	return `${days}${i18n(I18nKey.notesDaysAgo)}`;
}
---

<MainGridLayout title={i18n(I18nKey.notes)} description="即兴随笔">
	<div id="notes-timeline" class="relative w-full h-auto max-h-[calc(100dvh-5.5rem)] overflow-y-auto overflow-x-hidden hide-scrollbar flex flex-col">
		<!-- 页面头部 -->
		<div class="moments-header-container sticky top-0 z-40 shrink-0">
			<div class="moments-header mb-4">
				<div class="header-content">
					<div class="header-info">
						<h1 class="moments-title text-xl md:text-2xl font-bold text-white mb-1">{i18n(I18nKey.notes)}</h1>
						<p class="moments-subtitle text-sm md:text-base text-white/90">{i18n(I18nKey.notesSubtitle)}</p>
					</div>
					<div class="header-stats">
						<div class="stat-item text-center">
							<span class="stat-number text-xl md:text-2xl font-bold text-white">{notesStats.total}</span>
							<span class="stat-label text-xs md:text-sm text-white/80">{i18n(I18nKey.notesCount)}</span>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- 随笔列表 -->
		<div class="moments-timeline flex flex-col gap-4 pb-4 relative z-10">
			{groups.map((group, gi) => (
				<div class:list={["notes-group flex flex-col gap-4", { hidden: gi > 0 }]}>
					{group.map((note) => (
						<div class="moment-item card-base onload-animation p-6 md:p-7 transition-all">
							<div class="moment-content">
								<div
									class="moment-text custom-md markdown-content text-90 mb-3 md:mb-4"
									set:html={renderMarkdown(note.content)}
								></div>
								{note.images && note.images.length > 0 && (
									<div class="notes-images grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 md:gap-4 lg:gap-5 mb-3 md:mb-4">
										{note.images.map((image) => (
											<div class="image-item relative rounded-md overflow-hidden aspect-square cursor-pointer hover:scale-105 transition-transform">
												<ImageWrapper src={image} alt="notes moment image" class="w-full h-full" />
											</div>
										))}
									</div>
								)}
							</div>
							<div class="moment-footer flex justify-between items-center mt-2">
								<div class="moment-time flex items-center gap-1.5 text-sm text-black/30 dark:text-white/30 transition">
									<time datetime={note.date}>{formatTime(note.date)}</time>
								</div>
							</div>
						</div>
					))}
				</div>
			))}
		</div>
		<div id="load-more-trigger" class="h-8 w-full shrink-0"></div>
	</div>
</MainGridLayout>

<script is:inline>
function updateInitialTimes(){var times=document.querySelectorAll(".js-relative-time");for(var i=0;i<times.length;i++){var el=times[i];var d=el.getAttribute("data-date");if(d){el.textContent=fmt(d)}}}
var isRevealing=!1;
var observer;
function revealNextItem(){
    var hiddenGroups=document.querySelectorAll(".notes-group.hidden");
    if(hiddenGroups.length===0)return!1;
    var next=hiddenGroups[0];
    next.classList.remove("hidden");
    next.classList.add("slide-in-bottom");
    return!0;
}
function setupObserver() {
    var trigger = document.getElementById("load-more-trigger");
    var container = document.getElementById("notes-timeline");
    if (!trigger || !container) return;

    if (observer) observer.disconnect();

    observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting && !isRevealing) {
                isRevealing = true;
                setTimeout(() => {
                    var did = revealNextItem();
                    isRevealing = false;
                    if (!did) {
                        if(observer) observer.disconnect();
                        trigger.style.display = 'none';
                    }
                }, 100);
            }
        });
    }, {
        root: container,
        rootMargin: "300px",
        threshold: 0
    });

    observer.observe(trigger);
}

function setupHeaderScroll() {
    var container = document.getElementById("notes-timeline");
    var header = document.querySelector(".moments-header");
    if (!container || !header) return;

    var handleScroll = () => {
        if (container.scrollTop > 20) {
            header.classList.add("is-collapsed");
        } else {
            header.classList.remove("is-collapsed");
        }
    };

    container.addEventListener("scroll", handleScroll, { passive: true });
    // Initial check
    handleScroll();
}

if(document.readyState==="loading"){
    document.addEventListener("DOMContentLoaded", () => {
        setupObserver();
        setupHeaderScroll();
    });
}else{
    setupObserver();
    setupHeaderScroll();
}
document.addEventListener("astro:after-swap", () => {
    setupObserver();
    setupHeaderScroll();
});
</script>

<style is:global>
	.moments-header {
		padding: 1rem;
		padding-bottom: 1rem;
		border-radius: 16px;
		background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark, var(--primary)) 100%);
		color: white;
		overflow: hidden;
		box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
		transition: border-radius 0.25s ease;
	}
	
	.moments-header.is-collapsed {
		border-bottom-left-radius: 0;
		border-bottom-right-radius: 0;
		box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12); /* 可选：调整阴影使其看起来更像顶部栏 */
	}
	
	.header-content {
		display: flex;
		justify-content: space-between;
		align-items: center;
		position: relative;
		z-index: 1;
	}
	
	.moments-title {
		color: white;
		text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
	}
	
	.moments-subtitle {
		color: rgba(255, 255, 255, 0.9);
	}
	
	.stat-number {
		color: white;
	}
	
	.stat-label {
		color: rgba(255, 255, 255, 0.8);
	}
	
	.image-item img {
		transition: transform 0.3s ease;
	}
	
	.image-item:hover img {
		transform: scale(1.05);
	}
	
	.action-btn {
		background: none;
		border: none;
		cursor: pointer;
		color: var(--text-muted);
	}
	
	.action-btn:hover {
		color: var(--primary);
	}

	.moments-timeline {
		padding-top: 1.25rem;
		-webkit-overflow-scrolling: touch;
	}
	
	/* 手机端 (小于640px) */
	@media (max-width: 640px) {
		.moments-header {
			padding: 1rem;
			padding-bottom: 1rem;
		}
		
		.header-content {
			display: flex;
			justify-content: space-between;
			align-items: center;
			gap: 1rem;
		}
		
		.diary-images {
			grid-template-columns: repeat(2, 1fr);
		}
		
		.moment-footer {
			flex-direction: column;
			align-items: flex-start;
			gap: 0.5rem;
		}

		.moment-text {
			font-size: 1rem;
			line-height: 1.6;
		}
	}
	
	/* 平板竖屏 (641px - 900px) - 优化显示 */
	@media (min-width: 641px) and (max-width: 900px) {
		.moments-header {
			padding: 1rem;
			padding-bottom: 1rem;
		}
		
		.header-content {
			display: flex;
			justify-content: space-between;
			align-items: center;
		}
		
		.moment-item {
			padding: 1.5rem;
		}
		
		.diary-images {
			grid-template-columns: repeat(3, 1fr);
			gap: 0.75rem;
			max-width: 500px;
		}
		
		.moment-text {
			font-size: 1rem;
			line-height: 1.7;
		}
		
		.moment-footer {
			margin-top: 1rem;
		}
	}
	
	/* 平板横屏和桌面端 (大于900px) */
	@media (min-width: 901px) {
		.moments-header {
			padding: 1.25rem;
			padding-bottom: 1.25rem;
		}
		
		.moment-item {
			padding: 2rem;
		}
		
		.diary-images {
			grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
			max-width: 600px;
			gap: 1rem;
		}
		
		.moment-text {
			font-size: 1.1rem;
			line-height: 1.8;
		}
	}
	
	/* 优化小屏幕显示 */
	@media (max-width: 480px) {
		.moment-item {
			border-radius: 8px;
		}
		
		.moments-header {
			border-radius: 6px;
		}
	}
	
	.slide-in-bottom {
		animation: slide-in-bottom 0.6s cubic-bezier(0.22, 1, 0.36, 1) both;
		will-change: transform, opacity;
	}
	
	@keyframes slide-in-bottom {
		0% {
			transform: translateY(50px);
			opacity: 0;
		}
		100% {
			transform: translateY(0);
			opacity: 1;
		}
	}
</style>

